<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NOGA Architecture - Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f3f0;
}

/* Fen√™tre chat dans iframe */
#chatWindow {
  width: 100%;
  height: 100dvh;
  background: rgba(245, 243, 240, 0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden; 
}

/* meilleure hauteur mobile */
@supports (height: 100dvh) {
  #chatWindow { height: 100dvh; }
}

#chatMessages {
  flex: 1 1 auto;
  min-height: 0; /* ‚úÖ IMPORTANT iOS : √©vite input coup√© */
  padding: 26px 18px;
  padding-bottom: 10px;
  overflow-y: auto;
  overflow-x: hidden;
  background: transparent; 
  -webkit-overflow-scrolling: touch;
}

/* Messages bot */
.message-container {
  display: flex;
  align-items: flex-start;
  gap: 10px;              /* ‚úÖ espace avatar <-> texte */
  margin-bottom: 18px;
  animation: fadeIn 0.25s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.avatar {
  width: 34px;
  height: 34px;
  flex-shrink: 0;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.avatar img {
  width: 34px;
  height: 34px;
  object-fit: contain;
}

.message {
  background: rgba(255, 255, 255, 0.3);
  color: #5a4a3a;
  padding: 14px 16px;
  border-radius: 12px;
  max-width: 80%;
  white-space: pre-line;
  line-height: 1.55;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: 1px solid rgba(229, 227, 224, 0.3);
  font-size: 16px;
  backdrop-filter: blur(10px);  /* ‚Üê Effet de flou moderne (optionnel) */
  -webkit-backdrop-filter: blur(10px);  /* ‚Üê Safari */
}

/* Messages user */
.user-message-container {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 14px;
}

.message.user {
  background: #c4a77d;
  color: white;
  border: none;
  max-width: 80%;
  font-size: 16px;
  padding: 14px 16px;
  border-radius: 12px;
}

/* Boutons choix align√©s √† droite */
.response-buttons-wrap {
  display: flex;
  justify-content: flex-end;
  margin: 10px 0 18px 0;
}

.response-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 210px;
  width: 100%;
  align-items: stretch;
}

.response-btn {
  background: #c4a77d;
  color: white;
  border: none;
  padding: 12px 14px;
  border-radius: 10px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
  font-size: 15px;        /* ‚úÖ taille boutons desktop */
  font-weight: 500;
  width: 100%;
}

.response-btn:hover {
  background: #b39872;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(196,167,125,0.25);
}

/* Input */
#chatInput{
  flex: 0 0 auto;
  padding: 16px;
  padding-bottom: calc(24px + env(safe-area-inset-bottom)); /* ‚úÖ plus g√©n√©reux */
  position: sticky;        /* ‚úÖ reste visible m√™me si Safari ‚Äúglisse‚Äù */
  bottom: 0;
  background: white;
  border-top: 1px solid #e5e3e0;
}

#messageInput {
  flex: 1;
  padding: 12px 14px;
  border: 1px solid #e5e3e0;
  border-radius: 10px;
  font-size: 14px;
  outline: none;
  background: #f5f3f0;
  color: #5a4a3a;
}

#messageInput:focus {
  border-color: #c4a77d;
  background: white;
}

#sendBtn {
  background: #c4a77d;
  color: white;
  border: none;
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  font-size: 14px;
}

#sendBtn:hover { background: #b39872; }

/* Typing */
.typing-indicator {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 14px;
  background: white;
  border-radius: 12px;
  border: 1px solid #e5e3e0;
  width: fit-content;
  margin: 0 0 14px 50px; /* ‚âà avatar + gap */
}

.typing-indicator span {
  width: 7px;
  height: 7px;
  background: #c4a77d;
  border-radius: 50%;
  animation: typing 1.2s infinite;
  opacity: 0.7;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* ===== VRAI MOBILE (tactile) ===== */
@media (hover: none) and (pointer: coarse) {
  .avatar { display: none !important; }
  .message-container { gap: 0 !important; }

  .message, .message.user {
    font-size: 12px;
    padding: 10px 12px;
  }

  .response-buttons { max-width: 190px; }
  .response-btn {
    font-size: 12px;
    padding: 9px 12px;
  }

  #messageInput { font-size: 13px; }
  .typing-indicator { margin-left: 0 !important; }

   /* ===== BOUTON CALENDLY MOBILE ===== */
  a[href*="calendly"] {
    font-size: 14px !important;
    font-weight: 500 !important;
  }
}

/* ===== DESKTOP (souris) ===== */
@media (hover: hover) and (pointer: fine) {
  .avatar { display: flex !important; }
  .message, .message.user { font-size: 16px; }
  .response-btn { font-size: 15px !important; }
}
    /* ===== FIX MOBILE : bouton "Envoyer" coup√© ===== */
@media (hover: none) and (pointer: coarse) {
  #chatInput {
    gap: 8px;                 /* un peu moins d‚Äôespace */
  }

  #messageInput {
    min-width: 0;             /* OBLIGATOIRE en flex */
    flex: 1 1 auto;
  }

  #sendBtn {
    flex: 0 0 auto;           /* ne se fait pas √©craser */
    white-space: nowrap;      /* jamais de coupe */
    padding: 10px 10px;       /* plus compact */
    font-size: 13px;
  }
}

    /* ===== Desktop : espace input / bouton Envoyer ===== */
@media (hover: hover) and (pointer: fine) {
  #chatInput {
    gap: 14px;   /* ‚Üê espace entre input et bouton */
  }
}
  </style>
</head>

<body>
  <div id="chatWindow">
    <div id="chatMessages"></div>

    <div id="chatInput">
      <input type="text" id="messageInput" placeholder="Votre r√©ponse..." />
      <button id="sendBtn">Envoyer</button>
    </div>
  </div>

  <script>
    // === CONFIGURATION ===
    const WEBHOOK_PROJET_URL = "https://hook.eu1.make.com/57kfoul8689nxs8tmx49zeeq6h1gahsz";
    const WEBHOOK_FAQ_URL    = "https://hook.eu1.make.com/acnvakdpcuo5kx66lefs0j0v9jku49wj";
    const CALENDLY_URL       = "https://calendly.com/contact-nogaarchitecture/30min";
    const LOGO_URL           = "https://i.ibb.co/7dVBNZSV/Capture-d-e-cran-2025-07-07-a-10-44-30.png";

    // === PARCOURS ===
    const parcours = {
      accueil: {
        message: "Bienvenue chez NOGA Architecture, cabinet d'architecture d'int√©rieur sur la C√¥te d'Azur.\n\nComment puis-je vous accompagner ?",
        type: "buttons",
        options: [
          { texte: "D√©crire mon projet", valeur: "projet", suivant: "info_prenom" },
          { texte: "Prendre rendez-vous", valeur: "rdv", suivant: "rdv_prenom" },
          { texte: "Poser une question", valeur: "faq", suivant: "faq_question" }
        ]
      },

      // === PROJET ===
      info_prenom: {
        message: "Tr√®s bien ! Je vais vous guider pour identifier l'accompagnement id√©al.\nQuel est votre pr√©nom ?",
        type: "text",
        variable: "prenom",
        suivant: "info_ville"
      },
      info_ville: {
        message: (d) => `Enchant√© ${d.prenom} !\nDans quelle ville se situe votre projet ?`,
        type: "text",
        variable: "ville",
        suivant: "info_type_bien"
      },
      info_type_bien: {
        message: "De quel type de bien s'agit-il ?",
        type: "buttons",
        variable: "type_bien",
        options: [
          { texte: "Appartement", valeur: "Appartement", suivant: "info_surface" },
          { texte: "Maison", valeur: "Maison", suivant: "info_surface" },
          { texte: "Local commercial", valeur: "Local commercial", suivant: "info_surface" },
          { texte: "Autre", valeur: "Autre", suivant: "info_surface" }
        ]
      },
      info_surface: {
        message: "Quelle est la surface approximative du bien (en m¬≤) ?",
        type: "text",
        variable: "surface",
        suivant: "choix_service"
      },
      choix_service: {
        message: () =>
          `Merci!\n\nChez NOGA Architecture, nous proposons trois niveaux d'accompagnement :\n\nüèÜ Accompagnement complet : conception + coordination + r√©alisation avec nos entreprises partenaires.\n\nüé® Architecture d'int√©rieur : conception compl√®te (plans, mat√©riaux, finitions) et vous r√©alisez avec vos artisans.\n\nüîß Coordination de travaux : vous avez d√©j√† une base, nous coordonnons les travaux.\n\nQuel accompagnement vous correspond le mieux ?`,
        type: "buttons",
        variable: "service",
        options: [
          { texte: "Accompagnement complet", valeur: "Accompagnement complet", suivant: "gamme" },
          { texte: "Architecture d'int√©rieur", valeur: "Architecture d'int√©rieur", suivant: "gamme" },
          { texte: "Coordination de travaux", valeur: "Coordination de travaux", suivant: "gamme" }
        ]
      },
      gamme: {
        message: "Excellent choix ! Et quel niveau de finitions recherchez-vous ?\n\n‚≠ê Standard : Mat√©riaux fonctionnels, budget ma√Ætris√©\n\n‚≠ê‚≠ê Haut de gamme : Mat√©riaux premium, finitions soign√©es\n\n‚≠ê‚≠ê‚≠ê Luxe : Mat√©riaux nobles, sur-mesure",
        type: "buttons",
        variable: "gamme",
        options: [
          { texte: "Standard", valeur: "Standard", suivant: "budget_check" },
          { texte: "Haut de gamme", valeur: "Haut de gamme", suivant: "budget_check" },
          { texte: "Luxe", valeur: "Luxe", suivant: "budget_check" }
        ]
      },
      budget_check: {
        message: null,
        type: "condition",
        condition: (d) => (d.service === "Coordination de travaux" ? "budget_travaux" : "delai")
      },
      budget_travaux: {
        message: "Avez-vous une id√©e du budget travaux ?",
        type: "buttons",
        variable: "budget",
        options: [
          { texte: "Moins de 20 000‚Ç¨", valeur: "< 20k‚Ç¨", suivant: "delai" },
          { texte: "Entre 20 000 et 50 000‚Ç¨", valeur: "20-50k‚Ç¨", suivant: "delai" },
          { texte: "Entre 50 000 et 100 000‚Ç¨", valeur: "50-100k‚Ç¨", suivant: "delai" },
          { texte: "Plus de 100 000‚Ç¨", valeur: "> 100k‚Ç¨", suivant: "delai" }
        ]
      },
      delai: {
        message: "Quand souhaitez-vous commencer les travaux ?",
        type: "buttons",
        variable: "delai",
        options: [
          { texte: "D√®s que possible", valeur: "ASAP", suivant: "description" },
          { texte: "1 √† 3 mois", valeur: "1-3 mois", suivant: "description" },
          { texte: "3 √† 6 mois", valeur: "3-6 mois", suivant: "description" }
        ]
      },
      description: {
        message: () => "Pouvez-vous nous d√©crire votre projet ? (envies, contraintes, inspirations‚Ä¶)",
        type: "text",
        variable: "description",
        suivant: "email"
      },
      email: {
        message: (d) => `Merci ${d.prenom} !\nQuel est votre email ?`,
        type: "text",
        variable: "email",
        suivant: "telephone"
      },
      telephone: {
        message: "Et votre num√©ro de t√©l√©phone ?",
        type: "text",
        variable: "telephone",
        suivant: "fin_projet"
      },
      fin_projet: {
        message: async (d) => {
          await envoyerAMake(d, "projet");
          return `Merci ${d.prenom} !\n\nVotre demande a bien √©t√© enregistr√©e.\nNous vous recontactons tr√®s rapidement.\n\n√Ä tr√®s bient√¥t !`;
        },
        type: "final"
      },

      // === RDV ===
      rdv_prenom: {
        message: "D'accord, prenons rendez-vous !\nQuel est votre pr√©nom ?",
        type: "text",
        variable: "prenom_rdv",
        suivant: "rdv_email"
      },
      rdv_email: {
        message: (d) => `Merci ${d.prenom_rdv} ! Quel est votre email ?`,
        type: "text",
        variable: "email_rdv",
        suivant: "rdv_telephone"
      },
      rdv_telephone: {
        message: "Et votre num√©ro de t√©l√©phone ?",
        type: "text",
        variable: "telephone_rdv",
        suivant: "rdv_redirect"
      },
      rdv_redirect: {
  message: (d) => {
    const calendlyURL = `${CALENDLY_URL}?name=${encodeURIComponent(d.prenom_rdv)}&email=${encodeURIComponent(d.email_rdv)}&a1=${encodeURIComponent(d.telephone_rdv)}`;

    setTimeout(() => {
      const wrap = document.createElement("div");
      wrap.style.cssText = "display:flex; justify-content:flex-start; margin: 10px 0 18px 44px;";

      const btn = document.createElement("a");
      btn.href = calendlyURL;
      btn.target = "_blank";
      btn.textContent = "üìÖ Prendre rendez-vous";
      btn.style.cssText =
        "background:#c4a77d;color:white;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:600;display:inline-block";

      btn.addEventListener('mouseover', () => btn.style.background = '#b39872');
      btn.addEventListener('mouseout', () => btn.style.background = '#c4a77d');

      wrap.appendChild(btn);
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 250);

    return `Parfait ${d.prenom_rdv} !\nCliquez sur le bouton ci-dessous pour r√©server votre cr√©neau.`;
  },
  type: "final"
},

      // === FAQ ===
      faq_question: {
        message: "Posez-moi votre question, je vous r√©ponds üòä",
        type: "text",
        variable: "faq_question",
        suivant: "faq_reponse"
      },
      faq_reponse: {
        message: async (d) => {
          const reponse = await envoyerQuestionOpenAI(d.faq_question);
          return `${reponse}\n\nQue souhaitez-vous faire ?`;
        },
        type: "buttons",
        options: [
          { texte: "Prendre un rendez-vous", valeur: "rdv", suivant: "rdv_prenom" },
          { texte: "D√©crire mon projet", valeur: "projet", suivant: "info_prenom" },
          { texte: "Poser une autre question", valeur: "autre_faq", suivant: "faq_question" }
        ]
      }
    };

    // === VARIABLES & DOM ===
    let etapeActuelle = "accueil";
    let donneesUtilisateur = {};

    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatInput = document.getElementById("chatInput");

    // === UI ===
    function ajouterMessage(texte, estUtilisateur) {
  if (estUtilisateur) {
    const container = document.createElement("div");
    container.className = "user-message-container";

    const messageDiv = document.createElement("div");
    messageDiv.className = "message user";
    messageDiv.textContent = texte;

    container.appendChild(messageDiv);
    chatMessages.appendChild(container);
    
    // User : scroll en bas (normal)
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } else {
    const container = document.createElement("div");
    container.className = "message-container";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.innerHTML = `<img src="${LOGO_URL}" alt="NOGA">`;

    const messageDiv = document.createElement("div");
    messageDiv.className = "message";
    messageDiv.textContent = texte;

    container.appendChild(avatar);
    container.appendChild(messageDiv);
    chatMessages.appendChild(container);
    
    // Bot : scroll vers le HAUT du message
    setTimeout(() => {
  const containerTop = container.offsetTop;
  chatMessages.scrollTo({
    top: containerTop - 20,  // 20px de marge en haut
    behavior: 'smooth'
  });
}, 50);
  }
}
    function afficherTyping() {
      // √©vite doublons
      if (document.querySelector(".typing-indicator")) return;

      const typingDiv = document.createElement("div");
      typingDiv.className = "typing-indicator";
      typingDiv.innerHTML = "<span></span><span></span><span></span>";
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function retirerTyping() {
      const typingDiv = document.querySelector(".typing-indicator");
      if (typingDiv) typingDiv.remove();
    }

    function afficherBoutons(options) {
      const wrap = document.createElement("div");
      wrap.className = "response-buttons-wrap";

      const buttonsDiv = document.createElement("div");
      buttonsDiv.className = "response-buttons";

      options.forEach((option) => {
        const btn = document.createElement("button");
        btn.className = "response-btn";
        btn.textContent = option.texte;

        btn.onclick = () => {
          ajouterMessage(option.texte, true);
          sauvegarderReponse(option.valeur);
          allerEtape(option.suivant);
          wrap.remove();
        };

        buttonsDiv.appendChild(btn);
      });

      wrap.appendChild(buttonsDiv);
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sauvegarderReponse(valeur) {
      const etape = parcours[etapeActuelle];
      if (etape.variable) donneesUtilisateur[etape.variable] = valeur;
    }

    async function allerEtape(nouvelleEtape) {
      etapeActuelle = nouvelleEtape;
      const etape = parcours[etapeActuelle];

      if (etape.type === "condition") {
        const prochaine = etape.condition(donneesUtilisateur);
        return allerEtape(prochaine);
      }

      afficherTyping();

      try {
        await new Promise((resolve) => setTimeout(resolve, 220));

        const message =
          typeof etape.message === "function"
            ? await etape.message(donneesUtilisateur)
            : etape.message;

        if (message) ajouterMessage(message, false);

        if (etape.type === "buttons") {
          afficherBoutons(etape.options);
          chatInput.style.display = "none";
        } else if (etape.type === "text") {
          chatInput.style.display = "flex";
          messageInput.focus();
        } else {
          chatInput.style.display = "none";
        }
      } finally {
        retirerTyping();
      }
    }

    async function envoyerAMake(donnees, type) {
      const payload = { type, ...donnees, date: new Date().toISOString(), source: "Chat NOGA" };
      try {
        const response = await fetch(WEBHOOK_PROJET_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        return response.ok;
      } catch {
        return false;
      }
    }

    async function envoyerQuestionOpenAI(question) {
      const payload = {
        question,
        contexte: "NOGA Architecture - Cabinet d'architecture d'int√©rieur sur la C√¥te d'Azur",
      };

      try {
        const response = await fetch(WEBHOOK_FAQ_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) return "D√©sol√©, une erreur est survenue.";
        const texte = await response.text();
        const cleaned = (texte || "").replace(/^["']|["']$/g, "").trim();
        return cleaned || "Je n'ai pas pu obtenir de r√©ponse.";
      } catch (error) {
        return "Erreur de connexion.";
      }
    }

    // === EVENTS ===
    sendBtn.addEventListener("click", () => {
      const message = messageInput.value.trim();
      if (!message) return;

      ajouterMessage(message, true);
      sauvegarderReponse(message);
      messageInput.value = "";

      const etape = parcours[etapeActuelle];
      if (etape.suivant) allerEtape(etape.suivant);
    });

    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // start
    allerEtape("accueil");
  </script>
</body>
</html>
